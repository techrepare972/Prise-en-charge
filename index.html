<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TECHPRECISION - Gestion Atelier</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #0056b3;
            --secondary: #f4f4f4;
            --dark: #333;
            --danger: #dc3545;
            --success: #28a745;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--secondary); color: var(--dark); }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 90vh; }

        /* HEADER */
        .header-logo { text-align: center; margin-bottom: 30px; }
        .header-logo img { max-height: 80px; }
        h1, h2 { text-align: center; color: var(--primary); margin-top: 5px; }

        /* NAVIGATION (ÉCRANS) */
        .screen { display: none; }
        .screen.active { display: block; }

        /* MENU ACCUEIL */
        .home-menu { display: flex; flex-direction: column; gap: 20px; align-items: center; margin-top: 40px; }
        .btn-big { padding: 25px 40px; font-size: 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; max-width: 400px; text-decoration: none; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .btn-big:hover { background: #004494; transform: scale(1.02); }
        .btn-return { background-color: var(--success); }
        .btn-return:hover { background-color: #218838; }

        /* FORMULAIRES */
        .back-link { cursor: pointer; color: #666; text-decoration: none; font-weight: bold; display: inline-block; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.95rem; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        textarea { resize: vertical; height: 80px; font-family: inherit; }

        /* CANVAS SIGNATURE */
        .canvas-container { border: 2px dashed #ccc; background: #fff; position: relative; width: 100%; height: 200px; touch-action: none; border-radius: 4px; }
        canvas { width: 100%; height: 100%; display: block; }

        /* BOUTONS ACTIONS */
        .actions { display: flex; gap: 10px; margin-top: 25px; flex-wrap: wrap; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; color: white; font-weight: bold; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: #6c757d; }
        .btn-danger { background: var(--danger); }
        .btn-small { padding: 8px 12px; font-size: 0.8rem; width: auto; flex: none; margin-top: 5px; }

        /* PREVIEW PHOTOS */
        #photoPreview { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .preview-img { height: 80px; border: 1px solid #ddd; border-radius: 4px; object-fit: cover; }

        /* UTILITAIRES */
        .hidden { display: none; }
        
        /* Pour l'impression papier directe via navigateur (optionnel) */
        @media print {
            .actions, .back-link, input[type="file"], #clearSig { display: none; }
            .container { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-logo">
        <img src="logo.png" alt="TECHPRECISION Logo" id="companyLogo" onerror="this.style.display='none'">
        <h1>TECHPRECISION</h1>
    </div>

    <div id="homeScreen" class="screen active">
        <h2 style="color: #666; font-size: 1.2rem; font-weight: normal;">Gestion d'atelier</h2>
        <div class="home-menu">
            <button onclick="openForm('prise_en_charge')" class="btn-big">Prise en charge matériel</button>
            <button onclick="openForm('remise_materiel')" class="btn-big btn-return">Remise matériel</button>
        </div>
    </div>

    <div id="formScreen" class="screen">
        <a onclick="goHome()" class="back-link">&larr; Retour accueil</a>
        <h2 id="formTitle">Formulaire</h2>

        <form id="appForm">
            <div class="form-group">
                <label>Date du jour</label>
                <input type="date" id="date" required>
            </div>
            <div class="form-group">
                <label>Nom du Client</label>
                <input type="text" id="clientName" required placeholder="Nom Prénom">
            </div>
            <div class="form-group">
                <label>Téléphone</label>
                <input type="tel" id="phone" maxlength="10" required placeholder="0696..." pattern="\d{0,10}">
            </div>
            <div class="form-group">
                <label>Type de matériel</label>
                <select id="deviceType" required>
                    <option value="PC Portable">PC Portable</option>
                    <option value="PC Fixe">PC Fixe</option>
                    <option value="Console de jeu">Console de jeu</option>
                    <option value="Tablette">Tablette</option>
                    <option value="Smartphone">Smartphone</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <div class="form-group">
                <label>Modèle</label>
                <input type="text" id="model" placeholder="Ex: HP Pavilion, PS5...">
            </div>

            <div id="section-intake" class="hidden">
                <div class="form-group">
                    <label>État général</label>
                    <textarea id="condition" placeholder="Bon état, rayures, manque vis..."></textarea>
                </div>
                <div class="form-group">
                    <label>Problème constaté</label>
                    <textarea id="problem" placeholder="Ne s'allume pas, écran cassé..."></textarea>
                </div>
            </div>

            <div id="section-return" class="hidden">
                <div class="form-group">
                    <label>Réf. Prise en charge</label>
                    <input type="text" id="refIntake" placeholder="N° Dossier ou Date dépôt">
                </div>
                <div class="form-group">
                    <label>Travaux effectués / Commentaires</label>
                    <textarea id="workDone" placeholder="Remplacement disque dur, nettoyage..."></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>Photos (Max 2)</label>
                <input type="file" id="photoInput" accept="image/*" multiple capture="environment">
                <div id="photoPreview"></div>
            </div>

            <div class="form-group">
                <label>Signature du client</label>
                <div class="canvas-container">
                    <canvas id="sigCanvas"></canvas>
                </div>
                <button type="button" id="clearSig" class="btn btn-secondary btn-small">Effacer signature</button>
            </div>

            <div class="actions">
                <button type="submit" class="btn btn-primary">Générer PDF</button>
                <button type="button" onclick="resetForm()" class="btn btn-danger">Réinitialiser</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- VARIABLES GLOBALES ---
    const { jsPDF } = window.jspdf;
    let currentType = ''; // 'prise_en_charge' ou 'remise_materiel'
    let uploadedPhotos = []; // Stocke les images en base64

    // --- NAVIGATION ---
    function goHome() {
        document.getElementById('homeScreen').classList.add('active');
        document.getElementById('formScreen').classList.remove('active');
        resetFormData();
    }

    function openForm(type) {
        currentType = type;
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('formScreen').classList.add('active');
        
        // Configurer le titre et les champs visibles
        const titleEl = document.getElementById('formTitle');
        const intakeSec = document.getElementById('section-intake');
        const returnSec = document.getElementById('section-return');
        const problemField = document.getElementById('problem');

        // Date du jour par défaut
        document.getElementById('date').valueAsDate = new Date();

        if (type === 'prise_en_charge') {
            titleEl.innerText = "Fiche Prise en Charge";
            intakeSec.classList.remove('hidden');
            returnSec.classList.add('hidden');
            problemField.setAttribute('required', 'required'); // Obligatoire
        } else {
            titleEl.innerText = "Fiche Remise Matériel";
            intakeSec.classList.add('hidden');
            returnSec.classList.remove('hidden');
            problemField.removeAttribute('required');
        }
        
        resizeCanvas();
    }

    // --- GESTION PHOTOS ---
    document.getElementById('photoInput').addEventListener('change', function(e) {
        const files = e.target.files;
        const previewContainer = document.getElementById('photoPreview');
        
        if (files.length + uploadedPhotos.length > 2) {
            alert("Maximum 2 photos au total.");
            this.value = ''; 
            return;
        }

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(event) {
                // Stocker Base64
                if(uploadedPhotos.length < 2) {
                    uploadedPhotos.push(event.target.result);
                    // Afficher aperçu
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.className = 'preview-img';
                    previewContainer.appendChild(img);
                }
            };
            reader.readAsDataURL(file);
        });
    });

    // --- GESTION SIGNATURE (CANVAS) ---
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    function resizeCanvas() {
        // Ajuster la résolution interne du canvas à sa taille d'affichage
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
    }
    window.addEventListener('resize', resizeCanvas);

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    // Événements Souris
    canvas.addEventListener('mousedown', (e) => { isDrawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
    canvas.addEventListener('mousemove', (e) => { if (!isDrawing) return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); });
    canvas.addEventListener('mouseup', () => { isDrawing = false; });
    // Événements Tactiles
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); }, {passive: false});
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); if (!isDrawing) return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); }, {passive: false});
    canvas.addEventListener('touchend', () => { isDrawing = false; });

    document.getElementById('clearSig').addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // --- GÉNÉRATION PDF (LOGIQUE CŒUR) ---
    document.getElementById('appForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // 1. Récupération des données
        const date = document.getElementById('date').value;
        const clientName = document.getElementById('clientName').value;
        const phone = document.getElementById('phone').value;
        const deviceType = document.getElementById('deviceType').value;
        const model = document.getElementById('model').value;
        
        // Spécifiques
        const condition = document.getElementById('condition').value;
        const problem = document.getElementById('problem').value;
        const refIntake = document.getElementById('refIntake').value;
        const workDone = document.getElementById('workDone').value;

        // Signature
        const signatureImg = canvas.toDataURL('image/png');

        // 2. Initialisation jsPDF
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth(); // 210mm
        const margin = 20;
        const contentWidth = pageWidth - (margin * 2);
        let currentY = 20;

        // --- EN-TÊTE ---
        const logoEl = document.getElementById('companyLogo');
        // Vérification que le logo est bien chargé pour l'intégrer au PDF
        if (logoEl && logoEl.complete && logoEl.naturalHeight !== 0) {
            const c = document.createElement('canvas');
            c.width = logoEl.naturalWidth;
            c.height = logoEl.naturalHeight;
            // Utilisation de 'image/png' pour garder la transparence
            c.getContext('2d').drawImage(logoEl, 0, 0);
            const logoBase64 = c.toDataURL('image/png'); 
            
            // Intégration PNG dans le PDF
            doc.addImage(logoBase64, 'PNG', margin, currentY, 30, 20); 
        } else {
            // Fallback si logo manquant
            doc.rect(margin, currentY, 30, 20);
            doc.setFontSize(8);
            doc.text("LOGO", margin + 5, currentY + 12);
        }

        // Titre Entreprise
        doc.setFont("helvetica", "bold");
        doc.setFontSize(22);
        doc.text("TECHPRECISION", margin + 40, currentY + 10);
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("Service de réparation informatique", margin + 40, currentY + 18);

        currentY += 35;

        // Titre Document
        doc.setLineWidth(0.5);
        doc.line(margin, currentY, pageWidth - margin, currentY);
        currentY += 10;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        const docTitle = currentType === 'prise_en_charge' ? "FICHE DE PRISE EN CHARGE" : "FICHE DE REMISE MATERIEL";
        doc.text(docTitle, pageWidth / 2, currentY, { align: "center" });
        currentY += 15;

        // --- INFO CLIENT (2 colonnes) ---
        doc.setFontSize(10);
        const col1X = margin;
        const col2X = margin + 90;
        
        const printField = (label, val, x, y) => {
            doc.setFont("helvetica", "bold");
            doc.text(label + " :", x, y);
            doc.setFont("helvetica", "normal");
            doc.text(val || "-", x + 35, y);
        };

        printField("Date", date, col1X, currentY);
        printField("Matériel", deviceType, col2X, currentY);
        currentY += 8;

        printField("Client", clientName, col1X, currentY);
        printField("Modèle", model, col2X, currentY);
        currentY += 8;

        printField("Téléphone", phone, col1X, currentY);
        if (currentType === 'remise_materiel') {
            printField("Réf. Dossier", refIntake, col2X, currentY);
        }
        currentY += 15;

        // --- DÉTAILS TECHNIQUES ---
        doc.setDrawColor(200);
        doc.rect(margin, currentY, contentWidth, 60); 
        let textY = currentY + 8;

        if (currentType === 'prise_en_charge') {
            doc.setFont("helvetica", "bold");
            doc.text("État général :", margin + 2, textY);
            doc.setFont("helvetica", "normal");
            const splitCondition = doc.splitTextToSize(condition, contentWidth - 40);
            doc.text(splitCondition, margin + 35, textY);
            
            textY += 15;
            
            doc.setFont("helvetica", "bold");
            doc.text("Problème :", margin + 2, textY);
            doc.setFont("helvetica", "normal");
            const splitProblem = doc.splitTextToSize(problem, contentWidth - 35);
            doc.text(splitProblem, margin + 35, textY);
        } else {
            doc.setFont("helvetica", "bold");
            doc.text("Travaux effectués / Commentaires :", margin + 2, textY);
            textY += 8;
            doc.setFont("helvetica", "normal");
            const splitWork = doc.splitTextToSize(workDone, contentWidth - 10);
            doc.text(splitWork, margin + 5, textY);
        }

        currentY += 70;

        // --- PHOTOS (2 max) ---
        if (uploadedPhotos.length > 0) {
            doc.setFont("helvetica", "bold");
            doc.text("Photos du matériel :", margin, currentY);
            currentY += 5;
            
            let photoX = margin;
            uploadedPhotos.forEach(photoBase64 => {
                doc.addImage(photoBase64, 'JPEG', photoX, currentY, 70, 50);
                photoX += 75;
            });
            currentY += 55;
        } else {
            currentY += 10;
        }

        // --- SIGNATURE ---
        doc.setLineWidth(0.2);
        doc.line(margin, currentY, pageWidth - margin, currentY);
        currentY += 10;

        doc.setFont("helvetica", "bold");
        doc.text("Signature du client :", pageWidth - margin - 60, currentY);
        
        if (signatureImg) {
             doc.addImage(signatureImg, 'PNG', pageWidth - margin - 60, currentY + 5, 50, 25);
        }

        // --- FOOTER ---
        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.text(`Document généré par TECHPRECISION - ${new Date().toLocaleString()}`, margin, 285);

        // 3. Sauvegarde
        const filename = `${currentType}_${clientName.replace(/\s/g, '_')}.pdf`;
        doc.save(filename);
    });

    function resetFormData() {
        document.getElementById('appForm').reset();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('photoPreview').innerHTML = '';
        uploadedPhotos = [];
    }
    
    function resetForm() {
        if(confirm("Tout effacer ?")) {
            resetFormData();
        }
    }
</script>

</body>
</html>
