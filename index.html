<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechPrecision - Gestion des fiches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .aspect-a7 {
            aspect-ratio: 1 / 1;
        }
        #form-container {
            display: none;
        }
        .btn-primary {
            @apply bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out flex items-center justify-center space-x-2;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150 ease-in-out flex items-center justify-center space-x-2;
        }
        
        /* Styles spécifiques pour le PDF invisible (Ghost container) */
        .pdf-mode {
            background-color: white !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            padding: 40px !important; /* Marges papier */
            max-width: none !important;
            width: 794px !important; /* Largeur A4 en pixels (96dpi) */
            margin: 0 !important;
            color: #000 !important;
        }
        .pdf-mode header {
            margin-bottom: 20px !important;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
        }
        .pdf-mode .pdf-value {
            background-color: #f9fafb; /* Gris très clair */
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            font-weight: 700; /* Gras pour les données saisies */
            color: #111827;
            border-radius: 4px;
            margin-top: 4px;
            font-size: 14px;
        }
        .pdf-mode label {
            color: #4b5563;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
    </style>
</head>

<body class="p-4 sm:p-6 md:p-8">

    <div id="selection-screen" class="max-w-2xl mx-auto text-center">
        <header class="mb-10">
            <div class="mx-auto mb-4 h-14 w-14 flex items-center justify-center bg-blue-600 text-white rounded-full font-bold text-2xl">T</div>
            <h1 class="text-3xl font-bold text-gray-800">TECHPRECISION</h1>
            <p class="text-gray-600 mt-2">Gestion des fiches - Veuillez sélectionner un type de fiche</p>
        </header>
        <div class="bg-white rounded-lg shadow-2xl p-8 space-y-6">
            <button id="btn-prise-en-charge" class="w-full text-left p-6 bg-slate-50 hover:bg-blue-100 rounded-lg border border-slate-200 transition duration-200 flex items-center space-x-4">
                <div class="bg-blue-100 text-blue-600 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Fiche de prise en charge</h2>
                    <p class="text-gray-600">Pour enregistrer un nouveau matériel déposé par un client.</p>
                </div>
            </button>
            <button id="btn-remise-client" class="w-full text-left p-6 bg-slate-50 hover:bg-green-100 rounded-lg border border-slate-200 transition duration-200 flex items-center space-x-4">
                 <div class="bg-green-100 text-green-600 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Fiche de remise client</h2>
                    <p class="text-gray-600">Pour acter la restitution du matériel réparé au client.</p>
                </div>
            </button>
        </div>
    </div>


    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-2xl p-8" id="form-container">
        <header id="form-header" class="text-center mb-10">
             <div class="mx-auto mb-4 h-12 w-12 flex items-center justify-center bg-blue-600 text-white rounded-full font-bold text-xl">T</div>
            <h1 class="text-3xl font-bold text-gray-800 tracking-tight">TECHPRECISION</h1>
            <h2 id="form-title" class="text-xl font-medium text-gray-500 mt-1 uppercase tracking-wide"></h2>
        </header>

        <div id="form-body-wrapper">
            <form id="support-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <div>
                        <label for="date" id="date-label" class="block text-sm font-medium text-gray-700"></label>
                        <input type="text" id="date" name="date" readonly class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2">
                    </div>
                    <div class="flex items-end space-x-4">
                        <div class="flex-shrink-0 w-24">
                            <label class="block text-sm font-medium text-gray-700">Civilité</label>
                            <select id="civilite" name="civilite" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2">
                                <option>Mr</option>
                                <option>Mme</option>
                            </select>
                        </div>
                        <div class="flex-grow">
                            <label for="nom" class="block text-sm font-medium text-gray-700">Nom du client</label>
                            <input type="text" id="nom" name="nom" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2" placeholder="Prénom et Nom">
                        </div>
                    </div>
                </div>

                <div>
                    <label for="telephone" class="block text-sm font-medium text-gray-700">Numéro de téléphone</label>
                    <input type="tel" id="telephone" name="telephone" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2" placeholder="06 12 34 56 78">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="type_materiel" class="block text-sm font-medium text-gray-700">Type de matériel</label>
                        <select id="type_materiel" name="type_materiel" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2">
                            <option>Pc portable</option>
                            <option>Smartphone</option>
                            <option>Tablette</option>
                            <option>Console de jeu</option>
                            <option>Tour PC</option>
                            <option>Autre</option>
                        </select>
                    </div>
                    <div>
                        <label for="marque" class="block text-sm font-medium text-gray-700">Marque et modèle</label>
                        <input type="text" id="marque" name="marque" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2" placeholder="Ex: Apple Macbook Pro 14">
                    </div>
                </div>

                <div>
                    <label for="probleme" id="probleme-label" class="block text-sm font-medium text-gray-700"></label>
                    <textarea id="probleme" name="probleme" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2"></textarea>
                </div>
                 <div>
                    <label for="etat_materiel" class="block text-sm font-medium text-gray-700">État général du matériel</label>
                    <select id="etat_materiel" name="etat_materiel" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2">
                        <option>Bon état</option>
                        <option>Rayures d'usage</option>
                        <option>Choc visible</option>
                        <option>Écran cassé</option>
                        <option>Mauvais état</option>
                    </select>
                </div>

                <div id="photos-section">
                    <label class="block text-sm font-medium text-gray-700">Ajouter des photos (2 maximum)</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md bg-gray-50 hover:bg-gray-100 transition">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600 justify-center">
                                <label for="file-upload" class="relative cursor-pointer rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                    <span>Téléchargez des fichiers</span>
                                    <input id="file-upload" name="file-upload" type="file" class="sr-only" multiple accept="image/*,.heic,.heif">
                                </label>
                            </div>
                            <p class="text-xs text-gray-500">JPG, PNG, HEIC</p>
                        </div>
                    </div>
                    <div id="image-previews" class="mt-4 grid grid-cols-2 gap-4"></div>
                </div>

                <div class="break-inside-avoid">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Signature du client</label>
                    <div class="relative">
                        <canvas id="signature-pad" class="w-full h-40 bg-gray-50 border border-gray-300 rounded-md cursor-crosshair"></canvas>
                        <button type="button" id="clear-signature" class="absolute top-2 right-2 bg-white border border-gray-300 text-gray-600 text-xs px-2 py-1 rounded shadow-sm hover:bg-gray-100">Effacer</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 italic">Signer dans le cadre ci-dessus</p>
                </div>
            </form>
            
            <div id="error-container" class="text-left text-sm text-red-600 h-5 mt-2 font-medium"></div>
            <div class="mt-6 pt-5 border-t border-gray-200">
                <div class="flex justify-between space-x-3">
                    <button type="button" id="back-to-selection" class="btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                        <span>Retour</span>
                    </button>
                    <button type="button" id="export-pdf" class="btn-primary">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                         </svg>
                        <span>Générer PDF</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="pdf-mentions" class="hidden">
        <footer class="text-justify text-[9px] text-gray-500 mt-8 pt-4 border-t border-gray-300 leading-tight">
            <h4 class="font-bold mb-1 uppercase text-gray-700">Conditions Générales & Mentions</h4>
            <p class="mb-1"><strong>Responsabilité des données :</strong> Le client reconnaît être le seul responsable de la sauvegarde de l'intégralité de ses données avant de confier son matériel. TechPrecision ne pourra en aucun cas être tenue pour responsable de la perte de données.</p>
            <p class="mb-1"><strong>Garantie :</strong> Nos interventions et les pièces détachées sont garanties pour une durée de 3 mois à compter de la date de restitution de l'appareil. Cette garantie couvre uniquement la panne ou le défaut objet de la présente réparation.</p>
            <p><strong>Acceptation :</strong> La signature de cette fiche vaut acceptation sans réserve de nos conditions générales de réparation et de restitution ainsi que de l'état des lieux du matériel décrit ci-dessus.</p>
        </footer>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global Variables ---
            const selectionScreen = document.getElementById('selection-screen');
            const formContainer = document.getElementById('form-container');
            const btnPriseEnCharge = document.getElementById('btn-prise-en-charge');
            const btnRemiseClient = document.getElementById('btn-remise-client');
            const btnBackToSelection = document.getElementById('back-to-selection');
            
            const supportForm = document.getElementById('support-form');
            const dateField = document.getElementById('date');
            const fileInput = document.getElementById('file-upload');
            const previewsContainer = document.getElementById('image-previews');
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');

            const formTitle = document.getElementById('form-title');
            const dateLabel = document.getElementById('date-label');
            const problemeLabel = document.getElementById('probleme-label');
            const problemeTextarea = document.getElementById('probleme');
            
            let currentFormType = ''; // 'prise-en-charge' or 'remise-client'
            let uploadedFiles = [];
            let drawing = false;
            let lastPos = { x: 0, y: 0 };
            let hasSigned = false;

            // --- Fonctions ---

            function setTodayDate() {
                const today = new Date();
                dateField.value = today.toLocaleDateString('fr-FR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function resetForm() {
                supportForm.reset();
                previewsContainer.innerHTML = '';
                uploadedFiles = [];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hasSigned = false;
                setTodayDate();
                const errorContainer = document.getElementById('error-container');
                errorContainer.textContent = '';
                supportForm.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
            }
            
            function validateForm() {
                const requiredFields = supportForm.querySelectorAll('[required]');
                const errorContainer = document.getElementById('error-container');
                let allValid = true;
                
                errorContainer.textContent = '';
                requiredFields.forEach(field => field.classList.remove('border-red-500'));

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        allValid = false;
                        field.classList.add('border-red-500');
                    }
                });

                if (!allValid) {
                    errorContainer.textContent = "Veuillez remplir tous les champs obligatoires.";
                }
                return allValid;
            }

            function setupForm(formType) {
                currentFormType = formType;
                resetForm(); // Reset form state before showing

                if (formType === 'prise-en-charge') {
                    formTitle.textContent = 'Fiche de Prise en Charge';
                    dateLabel.textContent = 'Date de dépôt';
                    problemeLabel.textContent = 'Problème constaté / Demande';
                    problemeTextarea.placeholder = 'Ex: Écran cassé, ne s\'allume plus, batterie HS...';
                } else if (formType === 'remise-client') {
                    formTitle.textContent = 'Fiche de Restitution';
                    dateLabel.textContent = 'Date de sortie';
                    problemeLabel.textContent = 'Intervention réalisée / Remarques';
                    problemeTextarea.placeholder = 'Ex: Remplacement écran LCD, test ok...';
                }

                // Switch views
                selectionScreen.style.display = 'none';
                formContainer.style.display = 'block';
                // Scroll to top
                window.scrollTo(0, 0);
                resizeCanvas(); 
            }

            // --- Initialisation & Event Listeners ---

            setTodayDate();

            btnPriseEnCharge.addEventListener('click', () => setupForm('prise-en-charge'));
            btnRemiseClient.addEventListener('click', () => setupForm('remise-client'));
            btnBackToSelection.addEventListener('click', () => {
                formContainer.style.display = 'none';
                selectionScreen.style.display = 'block';
                currentFormType = '';
            });

            // Gestion de l'upload d'images
            fileInput.addEventListener('change', (event) => {
                const files = Array.from(event.target.files);
                handleFiles(files);
            });
            
            function handleFiles(files) {
                files.forEach(file => {
                    const isImage = file.type.startsWith('image/') || file.name.toLowerCase().endsWith('.heic');
                    if (uploadedFiles.length < 2 && isImage) {
                        uploadedFiles.push(file);
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const previewWrapper = document.createElement('div');
                            previewWrapper.className = 'relative w-full aspect-a7 border rounded-lg overflow-hidden shadow-sm bg-gray-100';
                            previewWrapper.innerHTML = `
                                <img src="${e.target.result}" class="w-full h-full object-cover">
                                <button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs leading-none w-6 h-6 flex items-center justify-center shadow hover:bg-red-600 transition">&times;</button>
                            `;
                            previewsContainer.appendChild(previewWrapper);
                            
                            previewWrapper.querySelector('button').addEventListener('click', () => {
                                const index = uploadedFiles.indexOf(file);
                                if (index > -1) {
                                    uploadedFiles.splice(index, 1);
                                }
                                previewsContainer.removeChild(previewWrapper);
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Gestion de la signature
            function resizeCanvas() {
                // Ensure canvas is visible before measuring
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }
            window.addEventListener('resize', resizeCanvas);

            function getMousePos(canvasDom, mouseEvent) {
                const rect = canvasDom.getBoundingClientRect();
                return { x: mouseEvent.clientX - rect.left, y: mouseEvent.clientY - rect.top };
            }
            
            function getTouchPos(canvasDom, touchEvent) {
                const rect = canvasDom.getBoundingClientRect();
                return { x: touchEvent.touches[0].clientX - rect.left, y: touchEvent.touches[0].clientY - rect.top };
            }

            function draw(pos) {
                if (!drawing) return;
                ctx.beginPath();
                ctx.moveTo(lastPos.x, lastPos.y);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                lastPos = pos;
                hasSigned = true;
            }

            canvas.addEventListener('mousedown', (e) => { drawing = true; lastPos = getMousePos(canvas, e); });
            canvas.addEventListener('mouseup', () => drawing = false);
            canvas.addEventListener('mousemove', (e) => draw(getMousePos(canvas, e)));
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; lastPos = getTouchPos(canvas, e); });
            canvas.addEventListener('touchend', (e) => { e.preventDefault(); drawing = false; });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(getTouchPos(canvas, e)); });
            document.getElementById('clear-signature').addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hasSigned = false;
            });
            
            // --- Actions d'Export ---
            
            const { jsPDF } = window.jspdf;
            
            document.getElementById('export-pdf').addEventListener('click', () => {
                if (!validateForm()) return;

                // 1. Prepare the Clone
                const formToExport = document.getElementById('form-container');
                const renderContainer = formToExport.cloneNode(true);
                
                // 2. Apply "PDF Mode" Styling (Transform from Web App to Document)
                renderContainer.classList.add('pdf-mode');
                renderContainer.style.position = 'absolute';
                renderContainer.style.left = '-9999px';
                renderContainer.style.top = '0';
                
                // Add legal mentions footer
                const mentionsFooter = document.getElementById('pdf-mentions').cloneNode(true);
                mentionsFooter.classList.remove('hidden');
                renderContainer.querySelector('#form-body-wrapper').appendChild(mentionsFooter);

                document.body.appendChild(renderContainer);

                // 3. Clean up UI elements (hide buttons, file inputs)
                const elementsToHide = [
                    ...renderContainer.querySelectorAll('button'),
                    ...renderContainer.querySelectorAll('#error-container'),
                    renderContainer.querySelector('#file-upload').closest('.border-dashed') // Hide the drag & drop area
                ];
                elementsToHide.forEach(el => {
                    if(el) el.style.display = 'none';
                });

                // 4. Convert Inputs to clean Text
                const fieldsToConvert = renderContainer.querySelectorAll('input, select, textarea');

                fieldsToConvert.forEach(field => {
                    const textValue = document.createElement('div');
                    textValue.className = 'pdf-value'; // See CSS for styling
                    
                    const originalField = document.getElementById(field.id); 
                    let displayValue = '';

                    if (field.tagName === 'SELECT') {
                        displayValue = originalField.options[originalField.selectedIndex].text;
                    } else {
                        displayValue = originalField.value;
                    }

                    if (!displayValue || displayValue.trim() === '') {
                        displayValue = '-';
                    }

                    textValue.textContent = displayValue;
                    textValue.style.whiteSpace = 'pre-wrap'; // Preserve line breaks for textarea
                    
                    field.style.display = 'none';
                    field.parentNode.insertBefore(textValue, field);
                });
                
                // 5. Handle Canvas (Signature)
                const clonedCanvas = renderContainer.querySelector('#signature-pad');
                if (hasSigned) {
                    // Create an image from original canvas
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL();
                    img.className = 'w-full h-40 border border-gray-300 rounded-md';
                    clonedCanvas.parentNode.replaceChild(img, clonedCanvas);
                } else {
                     // Empty signature placeholder
                     const emptySig = document.createElement('div');
                     emptySig.className = 'w-full h-40 border border-gray-300 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 italic';
                     emptySig.textContent = 'Non signé';
                     clonedCanvas.parentNode.replaceChild(emptySig, clonedCanvas);
                }

                // 6. Handle Images Previews
                const originalPreviews = previewsContainer.querySelectorAll('img');
                const clonedPreviewsContainer = renderContainer.querySelector('#image-previews');
                clonedPreviewsContainer.innerHTML = ''; // Clear cloned content
                
                if (originalPreviews.length > 0) {
                     originalPreviews.forEach(img => {
                        const previewWrapper = document.createElement('div');
                        previewWrapper.className = 'relative w-full aspect-a7 border border-gray-300 rounded-lg overflow-hidden';
                        const newImg = document.createElement('img');
                        newImg.src = img.src;
                        newImg.className = 'w-full h-full object-cover';
                        previewWrapper.appendChild(newImg);
                        clonedPreviewsContainer.appendChild(previewWrapper);
                    });
                } else {
                    document.getElementById('photos-section').style.display = 'none'; // Hide section if no photos
                }


                // 7. Render with High Quality Settings
                html2canvas(renderContainer, { 
                    scale: 3, // High resolution
                    useCORS: true,
                    backgroundColor: '#ffffff', // Force white background
                    windowWidth: 1024 // Ensure layout consistency
                })
                    .then(canvas => {
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        
                        const pageHeight = pdf.internal.pageSize.getHeight();
                        const pageWidth = pdf.internal.pageSize.getWidth();
                        const imgProps = pdf.getImageProperties(imgData);
                        const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;
                        
                        pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pdfHeight);

                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                        const clientName = document.getElementById('nom').value.replace(/[^a-z0-9]/gi, '_').substring(0, 15) || 'client';
                        const filePrefix = currentFormType === 'prise-en-charge' ? 'PEC' : 'RESTITUTION';
                        const filename = `${filePrefix}_${clientName}.pdf`;

                        if (isIOS) {
                            window.open(pdf.output('bloburl'), '_blank');
                        } else {
                            pdf.save(filename);
                        }
                    })
                    .finally(() => {
                        document.body.removeChild(renderContainer);
                        // Reset Flow
                        formContainer.style.display = 'none';
                        selectionScreen.style.display = 'block';
                        currentFormType = '';
                    });
            });

            // Remove red borders on input
            supportForm.querySelectorAll('[required]').forEach(field => {
                field.addEventListener('input', () => {
                    if (field.value.trim()) {
                        field.classList.remove('border-red-500');
                    }
                });
            });
        });
    </script>
</body>
</html>
