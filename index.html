<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TECHPRECISION - Atelier</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0056b3;
            --bg: #f4f7f6;
            --white: #ffffff;
            --text: #2c3e50;
            --radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
        .container { max-width: 600px; margin: 0 auto; min-height: 100vh; padding-bottom: 40px; }
        * { box-sizing: border-box; }

        /* HEADER APP */
        .app-header { background: var(--white); padding: 20px; text-align: center; border-radius: 0 0 20px 20px; box-shadow: var(--shadow); margin-bottom: 25px; }
        .header-logo img { max-height: 50px; }
        .app-header h1 { font-size: 1.1rem; color: var(--primary); margin: 5px 0 0; }

        /* NAVIGATION */
        .screen { display: none; animation: fade 0.3s; }
        .screen.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* MENU ACCUEIL */
        .home-menu { display: grid; gap: 15px; padding: 20px; }
        .menu-btn {
            background: var(--white); padding: 25px; border-radius: var(--radius); text-align: center;
            box-shadow: var(--shadow); cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .menu-btn:active { transform: scale(0.98); }
        .menu-btn i { font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block; }
        .menu-btn h3 { margin: 0; font-size: 1rem; }
        .menu-btn.green i { color: #27ae60; }

        /* FORMULAIRE UI */
        .top-bar { display: flex; align-items: center; padding: 0 20px 15px; }
        .back-btn { background: var(--white); border: none; width: 40px; height: 40px; border-radius: 50%; box-shadow: var(--shadow); cursor: pointer; color: var(--text); margin-right: 15px; }
        
        .card { background: var(--white); margin: 0 20px 20px; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); }
        .card h4 { margin: 0 0 15px; color: #7f8c8d; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #34495e; }
        
        /* INPUTS MODERNES */
        .input-box { position: relative; }
        .input-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #bdc3c7; }
        input, select, textarea {
            width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #ecf0f1; border-radius: 8px;
            font-size: 0.95rem; font-family: inherit; background: #fdfdfd; appearance: none;
        }
        textarea { padding-left: 15px; height: 80px; resize: none; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: #fff; }

        /* PHOTOS & CANVAS */
        #photoPreview { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .preview-img { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; background: #eee; }
        
        .canvas-wrap { border: 2px dashed #bdc3c7; border-radius: 8px; height: 160px; position: relative; background: #fff; }
        canvas { width: 100%; height: 100%; display: block; cursor: crosshair; }
        .canvas-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #eee; font-size: 1.5rem; pointer-events: none; }

        /* BOUTONS */
        .actions { padding: 20px; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 50px; font-size: 1rem; font-weight: 600; box-shadow: 0 4px 10px rgba(0, 86, 179, 0.3); cursor: pointer; }
        .btn-reset { background: none; border: none; color: #e74c3c; width: 100%; margin-top: 15px; cursor: pointer; text-decoration: underline; }
        .btn-small { background: #eee; border: none; padding: 5px 10px; border-radius: 4px; color: #555; font-size: 0.8rem; margin-top: 5px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="homeScreen" class="screen active">
        <header class="app-header">
            <div class="header-logo"><img src="logo.png" alt="Logo" id="logoImg" onerror="this.style.display='none'"></div>
            <h1>TECHPRECISION</h1>
        </header>

        <div class="home-menu">
            <div onclick="openForm('prise_en_charge')" class="menu-btn">
                <i class="fas fa-tools"></i>
                <h3>Prise en charge</h3>
            </div>
            <div onclick="openForm('remise_materiel')" class="menu-btn green">
                <i class="fas fa-check-circle"></i>
                <h3>Remise matériel</h3>
            </div>
        </div>
    </div>

    <div id="formScreen" class="screen">
        <div class="top-bar">
            <button onclick="goHome()" class="back-btn"><i class="fas fa-arrow-left"></i></button>
            <h2 style="margin:0; font-size:1.2rem;">Formulaire</h2>
        </div>

        <form id="appForm">
            <div class="card">
                <h4><i class="fas fa-user"></i> Client</h4>
                <div class="form-group">
                    <label>Date</label>
                    <div class="input-box"><i class="fas fa-calendar"></i><input type="date" id="date" required></div>
                </div>
                <div class="form-group">
                    <label>Nom Complet</label>
                    <div class="input-box"><i class="fas fa-id-card"></i><input type="text" id="clientName" required placeholder="Ex: Jean Dupont"></div>
                </div>
                <div class="form-group">
                    <label>Téléphone</label>
                    <div class="input-box"><i class="fas fa-phone"></i><input type="tel" id="phone" maxlength="10" required placeholder="0696..." pattern="\d{0,10}"></div>
                </div>
            </div>

            <div class="card">
                <h4><i class="fas fa-laptop"></i> Matériel</h4>
                <div class="form-group">
                    <label>Type</label>
                    <div class="input-box"><i class="fas fa-desktop"></i>
                        <select id="deviceType" required>
                            <option value="PC Portable">PC Portable</option>
                            <option value="PC Fixe">PC Fixe</option>
                            <option value="Console">Console de jeu</option>
                            <option value="Tablette">Tablette</option>
                            <option value="Smartphone">Smartphone</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Modèle</label>
                    <div class="input-box"><i class="fas fa-tag"></i><input type="text" id="model" placeholder="Ex: HP Pavilion, iPhone 12..."></div>
                </div>
            </div>

            <div class="card">
                <h4><i class="fas fa-list"></i> Détails</h4>
                
                <div id="section-intake" class="hidden">
                    <div class="form-group">
                        <label>État général</label>
                        <div class="input-box"><i class="fas fa-search"></i>
                            <select id="condition">
                                <option value="Bon état">Bon état</option>
                                <option value="Quelques traces d'usure">Quelques traces d'usure</option>
                                <option value="Mauvais état">Mauvais état</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Problème constaté</label>
                        <textarea id="problem" placeholder="Décrire la panne..."></textarea>
                    </div>
                </div>

                <div id="section-return" class="hidden">
                    <div class="form-group">
                        <label>Réf. Prise en charge</label>
                        <div class="input-box"><i class="fas fa-file-alt"></i><input type="text" id="refIntake" placeholder="N° Dossier..."></div>
                    </div>
                    <div class="form-group">
                        <label>Travaux effectués</label>
                        <textarea id="workDone" placeholder="Réparations effectuées..."></textarea>
                    </div>
                </div>
            </div>

            <div class="card">
                <h4><i class="fas fa-camera"></i> Photos (Max 2)</h4>
                <input type="file" id="photoInput" accept="image/*" multiple capture="environment" style="display:none">
                <button type="button" onclick="document.getElementById('photoInput').click()" class="btn-small" style="width:100%; padding:10px; font-size:0.9rem;">+ Ajouter Photo</button>
                <div id="photoPreview"></div>
            </div>

            <div class="card">
                <h4><i class="fas fa-pen-nib"></i> Signature</h4>
                <div class="canvas-wrap">
                    <span class="canvas-label">Signer ici</span>
                    <canvas id="sigCanvas"></canvas>
                </div>
                <button type="button" id="clearSig" class="btn-small">Effacer</button>
            </div>

            <div class="actions">
                <button type="submit" class="btn-main">Générer le PDF</button>
                <button type="button" onclick="resetForm()" class="btn-reset">Réinitialiser</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const { jsPDF } = window.jspdf;
    let currentType = '';
    let uploadedPhotos = []; 

    // --- NAVIGATION ---
    function goHome() {
        document.getElementById('homeScreen').classList.add('active');
        document.getElementById('formScreen').classList.remove('active');
        resetFormData();
    }

    function openForm(type) {
        currentType = type;
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('formScreen').classList.add('active');
        
        const intakeSec = document.getElementById('section-intake');
        const returnSec = document.getElementById('section-return');
        const problemField = document.getElementById('problem');
        
        document.getElementById('date').valueAsDate = new Date();

        if (type === 'prise_en_charge') {
            intakeSec.classList.remove('hidden');
            returnSec.classList.add('hidden');
            problemField.setAttribute('required', 'required');
        } else {
            intakeSec.classList.add('hidden');
            returnSec.classList.remove('hidden');
            problemField.removeAttribute('required');
        }
        setTimeout(resizeCanvas, 100); // Petit délai pour le rendu
    }

    // --- PHOTOS (LOGIQUE PRESERVÉE) ---
    document.getElementById('photoInput').addEventListener('change', function(e) {
        const files = e.target.files;
        if (files.length + uploadedPhotos.length > 2) {
            alert("2 photos maximum."); this.value = ''; return;
        }
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = new Image();
                img.onload = function() {
                    const cvs = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 1200;
                    if(w>h) { if(w>max){h*=max/w;w=max;} } else { if(h>max){w*=max/h;h=max;} }
                    cvs.width = w; cvs.height = h;
                    cvs.getContext('2d').drawImage(img,0,0,w,h);
                    const data = cvs.toDataURL('image/jpeg', 0.8);
                    
                    if(uploadedPhotos.length < 2) {
                        uploadedPhotos.push({data:data, w:w, h:h});
                        const pImg = document.createElement('img');
                        pImg.src = data; pImg.className = 'preview-img';
                        document.getElementById('photoPreview').appendChild(pImg);
                    }
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });
    });

    // --- SIGNATURE ---
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
    }
    window.addEventListener('resize', resizeCanvas);

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: cx - rect.left, y: cy - rect.top };
    }
    canvas.addEventListener('mousedown', e => { isDrawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
    canvas.addEventListener('mousemove', e => { if(!isDrawing)return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); });
    canvas.addEventListener('mouseup', () => isDrawing=false);
    canvas.addEventListener('touchstart', e => { e.preventDefault(); isDrawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); }, {passive:false});
    canvas.addEventListener('touchmove', e => { e.preventDefault(); if(!isDrawing)return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); }, {passive:false});
    canvas.addEventListener('touchend', () => isDrawing=false);
    document.getElementById('clearSig').addEventListener('click', () => ctx.clearRect(0,0,canvas.width,canvas.height));

    // --- GENERATION PDF (DESIGN "PRO") ---
    document.getElementById('appForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Données
        const d = {
            date: document.getElementById('date').value,
            name: document.getElementById('clientName').value,
            phone: document.getElementById('phone').value,
            type: document.getElementById('deviceType').value,
            model: document.getElementById('model').value,
            cond: document.getElementById('condition').value,
            prob: document.getElementById('problem').value,
            ref: document.getElementById('refIntake').value,
            work: document.getElementById('workDone').value
        };

        const doc = new jsPDF();
        const w = doc.internal.pageSize.getWidth();
        const m = 15; // Marge
        let y = 15;

        // --- 1. EN-TÊTE LOGO + TITRE ---
        const logo = document.getElementById('logoImg');
        if(logo && logo.complete && logo.naturalHeight !== 0) {
            const cvs = document.createElement('canvas'); 
            cvs.width = logo.naturalWidth; cvs.height = logo.naturalHeight;
            cvs.getContext('2d').drawImage(logo,0,0);
            doc.addImage(cvs.toDataURL('image/png'), 'PNG', m, y, 25, 16);
        }
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(20);
        doc.setTextColor(44, 62, 80); // Gris foncé
        doc.text("TECHPRECISION", w - m, y + 8, { align: "right" });
        doc.setFontSize(9);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(127, 140, 141); // Gris clair
        doc.text("Service de réparation informatique", w - m, y + 14, { align: "right" });

        y += 25;

        // --- 2. BANDEAU DE TITRE (BLEU) ---
        doc.setFillColor(0, 86, 179); // Bleu TechPrecision
        doc.rect(0, y, w, 12, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        const title = currentType === 'prise_en_charge' ? "FICHE DE PRISE EN CHARGE" : "FICHE DE REMISE MATERIEL";
        doc.text(title, w/2, y + 8, { align: "center", charSpace: 1 });
        
        y += 22;

        // --- 3. INFOS CLIENT (COLONNES) ---
        doc.setTextColor(44, 62, 80);
        doc.setFontSize(10);

        // Helper pour afficher Label: Valeur
        const row = (lbl, val, x) => {
            doc.setFont("helvetica", "bold");
            doc.text(lbl, x, y);
            doc.setFont("helvetica", "normal");
            doc.text(val || "-", x, y + 5);
        };

        // Colonne 1
        row("CLIENT", d.name, m);
        row("TÉLÉPHONE", d.phone, m + 60);
        row("DATE", d.date, m + 120);
        
        y += 15;
        
        // Colonne 2
        row("MATÉRIEL", d.type, m);
        row("MODÈLE", d.model, m + 60);
        if(currentType !== 'prise_en_charge') row("RÉF. DOSSIER", d.ref, m + 120);

        y += 15;

        // --- 4. DETAILS TECHNIQUES (ENCADRÉ GRIS) ---
        // Fond gris clair pour la section technique
        doc.setFillColor(245, 247, 250); // Gris très clair
        // On calcule la hauteur approx du cadre selon le contenu
        let boxHeight = 40; 
        if(d.prob.length > 50 || d.work.length > 50) boxHeight = 50;
        
        doc.setDrawColor(230, 230, 230);
        doc.roundedRect(m, y, w - (m*2), boxHeight, 3, 3, 'FD'); // FD = Fill + Draw borders

        let textY = y + 10;
        let textX = m + 5;
        let contentW = w - (m*2) - 10;

        if (currentType === 'prise_en_charge') {
            doc.setFont("helvetica", "bold");
            doc.text("ÉTAT GÉNÉRAL :", textX, textY);
            doc.setFont("helvetica", "normal");
            doc.text(d.cond, textX + 35, textY);
            
            textY += 10;
            doc.setFont("helvetica", "bold");
            doc.text("PROBLÈME :", textX, textY);
            doc.setFont("helvetica", "normal");
            const splitProb = doc.splitTextToSize(d.prob, contentW);
            doc.text(splitProb, textX, textY + 5);
        } else {
            doc.setFont("helvetica", "bold");
            doc.text("TRAVAUX EFFECTUÉS / COMMENTAIRES :", textX, textY);
            doc.setFont("helvetica", "normal");
            const splitWork = doc.splitTextToSize(d.work, contentW);
            doc.text(splitWork, textX, textY + 5);
        }

        y += boxHeight + 15;

        // --- 5. PHOTOS ---
        if (uploadedPhotos.length > 0) {
            // Check saut de page
            if (y > 220) { doc.addPage(); y = 20; }
            
            doc.setFont("helvetica", "bold");
            doc.text("PHOTOS", m, y);
            y += 5;

            let px = m;
            uploadedPhotos.forEach(p => {
                // Logique Portrait (50x70)
                let tw=50, th=70;
                let dw=tw, dh=th;
                
                // Centrage intelligent dans la boite 50x70
                if(p.w > p.h) {
                    dh = tw * (p.h/p.w);
                    doc.addImage(p.data, 'JPEG', px, y + ((th-dh)/2), tw, dh);
                } else {
                    dw = th * (p.w/p.h);
                    if(dw > tw) { dw=tw; dh=tw*(p.h/p.w); } // Si trop large malgré tout
                    doc.addImage(p.data, 'JPEG', px + ((tw-dw)/2), y, dw, dh);
                }
                // Petit cadre fin autour photo
                doc.setDrawColor(200);
                doc.rect(px, y, tw, th);
                px += 55;
            });
            y += 75;
        }

        // --- 6. SIGNATURE ---
        if (y > 250) { doc.addPage(); y = 20; }
        
        // Ligne séparation
        doc.setDrawColor(200);
        doc.line(m, y, w-m, y);
        y += 10;

        doc.setFont("helvetica", "bold");
        doc.text("SIGNATURE CLIENT", w - m - 50, y);
        
        const sigData = canvas.toDataURL('image/png');
        doc.addImage(sigData, 'PNG', w - m - 50, y + 5, 40, 20);

        // --- PIED DE PAGE ---
        doc.setFontSize(8);
        doc.setTextColor(150);
        const dateStr = new Date().toLocaleString('fr-FR');
        doc.text(`Document généré par TECHPRECISION le ${dateStr}`, m, 285);
        
        // Bande bleue fine tout en bas
        doc.setFillColor(0, 86, 179);
        doc.rect(0, 295, w, 2, 'F');

        // SAVE
        doc.save(`${currentType}_${d.name.replace(/\s/g,'_')}.pdf`);
    });

    function resetFormData() {
        document.getElementById('appForm').reset();
        ctx.clearRect(0,0,canvas.width,canvas.height);
        document.getElementById('photoPreview').innerHTML = '';
        uploadedPhotos = [];
    }
    
    function resetForm() { if(confirm("Effacer tout ?")) resetFormData(); }
</script>

</body>
</html>
